<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Usuários</title>
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.6/dayjs.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<div id="app" class="app">
		<div class="nav">
			<div class="logo">
				<img src="" alt="">
				logo
			</div>
			<div class="labs">
				<div :class="['labsItem', { 'click': produtosShow }]" @click="buscarProdutos()">Produtos</div>
				<div :class="['labsItem', { 'click': pedidosShow }]" @click="buscarPedidos">Pedidos</div>
				<div :class="['labsItem', { 'click': suporteShow }]" @click="abreSuporte()">Suporte</div>
			</div>
		</div>
		<div class="produtos" v-if="produtosShow">
			<div class="pesquisaCadastro">
				<div class="pesquisa">
					<div class="pesquisaTitulo">
						Cadastro de Usuários
					</div>
					<div class="pesquisaItem">
						<label for="">Usuário</label>
						<input type="text" class="form-control" placeholder="Buscar">
					</div>
					<div class="pesquisaItem">
						<label for="">Data</label>
						<input type="date" class="form-control">
					</div>
					<div class="pesquisaItem">
						<button class="btn btn-success" @click="buscarUsuarios">Buscar</button>
					</div>
				</div>
				<div class="cadastro">
					<button class="btn btn-primary" @click="abrirModalCadastrar">Cadastrar</button>
					<div class="modal" tabindex="-1" id="modalCadastrar">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title">Cadastro de Usuário</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
								</div>
								<div class="modal-body">
									<div class="cadastroUsuario">
										<form>
											<div class="formItem">
												<label for="">Nome</label>
												<input type="text" class="form-control" placeholder="Nome" v-model="nome">
											</div>
											<div class="formItem">
												<label for="">Sobrenome</label>
												<input type="text" class="form-control" placeholder="Sobrenome" v-model="sobrenome">
											</div>
											<div class="formItem">
												<label for="">Email</label>
												<input type="text" class="form-control" placeholder="Email" v-model="email">
											</div>
										</form>
									</div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
									<button type="submit" class="btn btn-success" :disabled="isFormInvalid"
										@click="cadastrarUsuario(nome, sobrenome, email)">Cadastrar
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="tabela">
				<div class="alert alert-primary" role="alert" v-show="carregandoTabela">
					Buscando dados...
				</div>
				<div class="alert alert-danger" role="alert" v-show="erroTabela">
					Não há dados para exibir.
				</div>
				<table class="table" v-show="!erroTabela && !carregandoTabela ">
					<thead>
						<tr>
							<th scope="col">Nº</th>
							<th scope="col">Nome</th>
							<th scope="col">sobrenome</th>
							<th scope="col">Email</th>
							<th scope="col">Data de criação</th>
							<th scope="col">Data de edição</th>
							<th scope="col">Opções</th>
						</tr>
					</thead>
					<tbody>
						<tr v-for="(usuario, index) in usuarios" :key="index">
							<td>{{ usuario.usuario_id }}</td>
							<td>{{ usuario.nome }}</td>
							<td>{{ usuario.sobrenome }}</td>
							<td>{{ usuario.email }}</td>
							<td>{{ usuario.data_cadastro }}</td>
							<td>{{ usuario.data_edicao }}</td>
							<td>
								<div class="botoes">
									<button @click="abrirModalEditar(usuario)" class="btn btn-primary">Editar</button>
									<div class="modal" tabindex="-1" id="modalEditar">
										<div class="modal-dialog">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title">Editar de Usuário</h5>
													<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<div class="cadastroUsuario">
														<form>
															<div class="formItem">
																<label for="">Nome</label>
																<input type="text" class="form-control" placeholder="Nome" v-model="nome">
															</div>
															<div class="formItem">
																<label for="">Sobrenome</label>
																<input type="text" class="form-control" placeholder="Sobrenome"
																	value=`${usuario.sobrenome}` v-model="sobrenome">
															</div>
															<div class="formItem">
																<label for="">Email</label>
																<input type="text" class="form-control" placeholder="Email" v-model="email">
															</div>
														</form>
													</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
													<button type="submit" class="btn btn-success" :disabled="isFormInvalid"
														@click="editarUsuario(nome, sobrenome, email, usuario.usuario_id)">Salvar alteração
													</button>
												</div>
											</div>
										</div>
									</div>
									<button @click="deletarUsuario(usuario.usuario_id, usuario.nome)"
										class="btn btn-danger">Excluir</button>
								</div>

							</td>
						</tr>
					</tbody>
				</table>
			</div>



		</div>
		<div class="pedidos" v-if="pedidosShow">
			Pedidos
		</div>
	</div>

	<script>
		const { createApp } = Vue;

		const app = createApp({
			data() {
				return {
					produtosShow: false,
					pedidosShow: false,
					usuarios: [],
					nome: '',
					sobrenome: '',
					email: '',
					carregandoTabela: false,
					erroTabela: false,
				}
			},
			computed: {
				isFormInvalid() {
					return !this.nome || !this.sobrenome || !this.email;
				},
			},
			methods: {
				buscarProdutos(){
					this.produtosShow = true
					this.pedidosShow = false
				},
				buscarPedidos(){
					this.produtosShow = false
					this.pedidosShow = true
				},
				abrirModalCadastrar() {
					$('#modalCadastrar').modal('show');
				},
				abrirModalEditar(usuario) {
					this.nome = usuario.nome;
					this.sobrenome = usuario.sobrenome;
					this.email = usuario.email;
					this.usuario = usuario;
					$('#modalEditar').modal('show');
				},

				async cadastrarUsuario(nome, sobrenome, email) {
					console.log("Dados:", nome, sobrenome, email);

					if (this.isFormInvalid) {
						alert('Por favor, preencha todos os campos.');
						return;
					}

					try {
						const response = await axios.post('http://localhost:3000/api/criar-usuario', {
							nome: this.nome,
							sobrenome: this.sobrenome,
							email: this.email
						});

						if (response.data.message) {
							alert("Usuário criado!")

							this.nome = ''
							this.sobrenome = ''
							this.email = ''
							$('#modalCadastrar').modal('hide');
						} else {
							alert("Erro ao criar usuário!")
						}

					} catch (error) {
						console.error('Error:', error);
						alert("Erro ao criar usuário!")
					}
					this.buscarUsuarios();


				},


				async buscarUsuarios() {
					this.carregandoTabela = true;
					this.erroTabela = false
					try {
						const response = await axios.get('http://localhost:3000/api/usuarios');
						if (response.data.length > 0) {
							this.usuarios = response.data;
							console.log("Usuários:", this.usuarios)
							this.carregandoTabela = false
						} else {
							this.erroTabela = true;
							this.carregandoTabela = false
						}

					} catch (error) {
						console.error('Error:', error);
						this.carregandoTabela = false
						this.erroTabela = true
					}

				},

				async editarUsuario(nome, sobrenome, email, id) {
					console.log("Id:", id)
					this.editar = true;
					this.menssagem = '';
					try {
						const response = await axios.post('http://localhost:3000/api/editar-nome', {
							nome: nome,
							sobrenome: sobrenome,
							email: email,
							usuario_id: id
						});

						if (response.data.message) {
							alert("Nome Atualizado");
							this.nome = ''
							this.sobrenome = ''
							this.email = ''

							$('#modalEditar').modal('hide');
						} else {
							this.menssagem = "O nome não foi Atualizado";
						}

					} catch (error) {
						console.error('Error:', error);
						this.menssagem = "O nome não foi Atualizado"
					}

					this.buscarUsuarios();
				},

				async deletarUsuario(id, nome) {
					try {
						const response = await axios.post('http://localhost:3000/api/deletar-usuario', {
							usuario_id: id,
							// nome: nome
						});

						if (response.data.message) {
							// alert(`Usuário ${id} deletado com sucesso!`);
							this.buscarUsuarios()
						} else {
							alert("O usuário não foi deletado!");
						}

					} catch (error) {
						console.error('Error:', error);
						alert("O usuário não foi deletado!");
					}
				}
			},
		})
			.mount('#app');
	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>